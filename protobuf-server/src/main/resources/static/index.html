<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Users</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <style>
        #users > tr:nth-child(even) td {
            background: #ccc;
        }

        #users > tr:nth-child(odd) td {
            background: #eee;
        }

        button {
            width: 60px;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(function () {
            $('body').append(buildUsersTable());
            $.get('/users', data => data.forEach(showUser));

            function buildUsersTable() {
                const input = $('<input type="text">');
                const submit = $('<button>Create</button>').click(() => httpCreate('/users', {
                    name: input.val()
                }, user => {
                    showUser(user);
                    input.val('');
                }));

                return $('<table id="users">')
                    .append($('<tr>')
                        .append($('<th>').append(input))
                        .append($('<th>').append(submit))
                        .append($('<th>'))
                    );
            }

            function buildNotesTable(user) {
                const input = $('<input type="text">');
                const submit = $('<button>Add</button>').click(() => httpCreate('/notes', {
                    text: input.val(),
                    user: user
                }, note => {
                    showNote(user, note);
                    input.val('');
                }));

                return $(`<table id="notes${user.id}">`)
                    .append($('<tr>')
                        .append($('<td>').append(input))
                        .append($('<td>').append(submit))
                    );
            }

            function showUser(user) {
                const row = $('<tr>');
                const deleteButton = $('<button>Delete</button>').click(() => $.ajax('/users/' + user.id, {
                    type: 'DELETE',
                    success: () => row.remove()
                }));
                $('#users').append(row
                    .append($('<td>').text(user.name))
                    .append($('<td>').append(deleteButton))
                    .append($('<td>').append(buildNotesTable(user)))
                );
                (user.notes || []).forEach(note => showNote(user, note));
            }

            function showNote(user, note) {
                const row = $('<tr>');
                const deleteButton = $('<button>Delete</button>').click(() => httpDelete(
                    '/notes/' + note.id,
                    () => row.remove()
                ));
                $(`#notes${user.id}`).append(row
                    .append($('<td>').text(note.text))
                    .append($('<td>').append(deleteButton)));
            }

            function httpCreate(url, body, callback) {
                $.ajax(url, {
                    type: 'POST',
                    data: JSON.stringify(body),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: callback
                });
            }

            function httpDelete(url, callback) {
                $.ajax(url, {
                    type: 'DELETE',
                    success: callback
                });
            }
        });
    </script>
</head>
<body>
</body>
</html>